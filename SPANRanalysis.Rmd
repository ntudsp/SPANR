---
title: "Replication code for: Anti-noise window: subjective perception of active noise reduction and effect of informational masking"
output: github_document
always_allow_html: true
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

#data packages
require(dataverse)
require(tidyverse)
require(broom)

#statistical packages
require(psych)
require(ARTool)
require(RTHORR)
require(lsr)
require(MVN)
require(rstatix)
require(car)

#formatting and graphics
require(kableExtra)
library(gridExtra)
library(RColorBrewer)
library(pals)
library(ggExtra)

#acoustic package
require(seewave)

library(raster)

library(rjson)


library(stringr)
library(ggrepel)
library(scales)
library(reshape2)

library(psychTools)






source("spanrFunc.R")
```

## Data loading

Load research data from dataverse data repository (https://doi.org/10.21979/N9/SEGEFM) into dataframes then consolidate them into a list data.l
1. data.subj: subjective response data from 44 participants
2. data.demo: demographic and pre-test assessment responses from 44 particiapnts
3. data.spla: A-weighted equivalent sound pressure level ($L_{Aeq}$) vs time of all stimuli at 6 measurement microphone positions and binaural channels from the HATS
4. data.splc: $L_{Ceq}$ vs time of all stimuli at 6 measurement microphone positions and binaural channels from the HATS
5. data.ffta: Frequency domain plots in $L_{Aeq}$ of of all stimuli at 6 measurement microphone positions and binaural channels from the HATS
6. data.fftc: Frequency domain plots in $L_{Ceq}$ of of all stimuli at 6 measurement microphone positions and binaural channels from the HATS
7. data,sv: Single value psychoacoustic and acoustic parameter data (see Table 1 in the paper) at 6 measurement microphone positions and binaural channels from the HATS


```{r dataload}
#Set dataverse server
Sys.setenv("DATAVERSE_SERVER" = "https://researchdata.ntu.edu.sg")

#Retrieve research data from dataverse dataset
dv.dataset = "10.21979/N9/SEGEFM" #dataset linked to this paper
#define a list of data frame names and associated dataset file names
data.names <- data.frame(
        df.name=c(
                "data.subj","data.demo","data.spla","data.splc",
                "data.ffta","data.fftc","data.sv","trackInfo"),
        filename=c("SPANR_subj_clean.tab","SPANR_demo_clean.tab",
                   "SPANR_SPLdBA_clean.tab","SPANR_SPLdBC_clean.tab",
                   "SPANR_FFTdBA_clean.tab","SPANR_FFTdBC_clean.tab",
                   "SPANR_sv_clean.tab",
                   "SPANR_soundtrack_information.tab"))

# Empty list to store the data frames
data.l <- list()

#iteratively retrieve research data from dataverse
for (name in data.names$df.name) {
        
        #get dataset from dataverse
        df<-get_dataframe_by_name(filename = data.names[data.names$df.name==name,
                                            "filename"],
                      dataset = dv.dataset, orginal = TRUE,
                      .f = function(x) read.table(x, header = TRUE, 
                                                  sep = "\t", fill = TRUE))
        #assign the data frame to pre-defined name
        assign(name, df)
        #add data frame to list
        data.l[[name]] <- df
}

```


## Reliability check

Examine the within-subject test-retest reliability of the subjective response data between stimuli #1 and #26

```{r explr, message=FALSE}

#no of participants from subjective response data
noPart<-length(unique(data.l[["data.subj"]]$ID))
        
#extract test tracks #1 and #26
data.trRel<-data.l[["data.subj"]] %>% 
        dplyr::filter(NoiseType=="Traffic" & SPL=="60dB") %>%
        #create time column, stimuli #1 & #3 correspond to 1st and 2nd assessments
        dplyr::mutate(time=ifelse(row_number()<(noPart+1),1,2))

#test-retest reliability between test tracks
trRel<-psych::testRetest(
        as.data.frame(data.trRel),
        select = c("annoyscale","loudness","pleasant","annoying",
                   "eventful","uneventful","vibrant","chaotic",
                   "monotonous","calm"))

#within person reliability
wPRel<-trRel$scores$rqq 

#ID of unreliable
IDunRel<-data.l[["data.subj"]]$ID[which(wPRel<0.7)][]

cat("ID number of unreliable responses: ",paste(as.character(IDunRel),collapse = ", "))

#Remove data with poor reliability <0.7
data.subj.rel <- data.l[["data.subj"]] %>% 
        dplyr::filter(!ID %in% IDunRel) %>%
        dplyr::mutate_at(.vars=c("NoiseType","Masker","SPL","ANC","annoycat"),
                         .funs = as.factor)

#Update demographic
data.demo.rel <- data.l[["data.demo"]] %>% 
        dplyr::filter(!ID %in% IDunRel) %>% 
        dplyr::filter(!ID==1)

```

## Single value objective indicators

```{r}

#stimuli names for plotting
stimuli.trackInfo.names <- trackInfo[2:nrow(trackInfo),] %>%
        dplyr::select(!c("No.")) %>%
        dplyr::mutate(NoiseType=ifelse(NoiseType=="Train","MRT",
                                ifelse(NoiseType=="Aircraft","AIR",
                                       ifelse(NoiseType=="Traffic","TRA",NoiseType))),
               Masker=ifelse(Masker=="Bird","B",
                             ifelse(Masker=="Water","W",Masker))) %>%
        dplyr::mutate(stimuliID=row_number()) %>%
        dplyr::mutate(stimuli.name.short=case_when(
                Masker=="None" & ANC == "No" ~ paste0(NoiseType,"@",SPL),
                Masker=="None" & ANC == "Yes" ~ paste0(NoiseType,"*@",SPL),
                Masker!="None" & ANC == "No" ~ paste0(NoiseType,"@",SPL,
                                                      "+",Masker),
                Masker!="None" & ANC == "Yes" ~ paste0(NoiseType,"*@",SPL,
                                                       "+",Masker))) %>%
        dplyr::mutate(stimuli.name=case_when(
                Masker=="None" & ANC == "No" ~ paste0(NoiseType,"['",
                                                      SPL,"(A)']"),
                Masker=="None" & ANC == "Yes" ~ paste0(NoiseType,"['",
                                                       SPL, "(A)']^'*'"),
                Masker!="None" & ANC == "No" ~ paste0(NoiseType,"['",
                                                      SPL,"(A)']+",Masker),
                Masker!="None" & ANC == "Yes" ~ paste0(NoiseType,"['",SPL,
                                                     "(A)']^'*'+",Masker)))

mean.SV <- data.l[["data.sv"]] %>%
        dplyr::select(!Channel) %>%
        dplyr::filter(!stimuliID==0) %>% #remove noise floor
        group_by(stimuliID,measurement) %>%
        dplyr::summarise(across(everything(),list(mean))) %>%
        ungroup %>%
        `colnames<-`(gsub("_1","",colnames(.))) %>%
        `colnames<-`(gsub("\\.$",")",colnames(.))) %>%
        `colnames<-`(gsub("\\.","(",colnames(.))) %>%
        pivot_longer(cols = !c("stimuliID","measurement"), 
                     names_to = "Indicator",values_to = "Value") %>%
        #add stimuli details by merging
        left_join(.,stimuli.trackInfo.names, by="stimuliID") %>%
        dplyr::select(!c("NoiseType","Masker","ANC","SPL",
                         "stimuliID","stimuli.name.short")) %>%
        pivot_wider(names_from = stimuli.name, values_from = Value) %>%
        `colnames<-`(cbind(c("measurement","indicator",
                             stimuli.trackInfo.names$stimuli.name.short)))

```
### dB Attenuation

```{r}
#compute difference before and after intervention only for dBA and dBC
mean.SV.att <- mean.SV %>%
        dplyr::filter(grepl("(C)|(A)", indicator)) %>%
        #compute attenuation
        dplyr::mutate(`AIR@65dB`=`AIR@65dB`-`AIR*@65dB`,
                      `MRT@65dB`=`MRT@65dB`-`MRT*@65dB`,
                      `TRA@65dB`=`TRA@65dB`-`TRA*@65dB`,
                      `AIR@70dB`=`AIR@70dB`-`AIR*@70dB`,
                      `MRT@70dB`=`MRT@70dB`-`MRT*@70dB`,
                      `TRA@70dB`=`TRA@70dB`-`TRA*@70dB`,
                      `AIR@65dB+B`=`AIR@65dB+B`-`AIR*@65dB+B`,
                      `MRT@65dB+B`=`MRT@65dB+B`-`MRT*@65dB+B`,
                      `TRA@65dB+B`=`TRA@65dB+B`-`TRA*@65dB+B`,
                      `AIR@65dB+W`=`AIR@65dB+W`-`AIR*@65dB+W`,
                      `MRT@65dB+W`=`MRT@65dB+W`-`MRT*@65dB+W`,
                      `TRA@65dB+W`=`TRA@65dB+W`-`TRA*@65dB+W`) %>%
        dplyr::select(!matches("\\*|60")) %>%
        dplyr::mutate(weight=ifelse(grepl("(C)",indicator),"C","A")) %>%
        group_by(measurement,weight) %>%
        dplyr::summarise_all(list(mean=mean,sd=sd))

#generate table of attenuation scores
table.sv.att<- mean.SV %>%
        `colnames<-`(cbind(c("measurement","indicator",
                             stimuli.trackInfo.names$stimuli.name))) %>%
        pivot_longer(names_to = "stimuli.name",values_to = "value",
                     cols = -c(1,2)) %>%
        pivot_wider(names_from = indicator, values_from = value) %>%
        dplyr::mutate(
                PA=ifelse(S>1.75,
                          N5*(1+sqrt(((S-1.75)*0.25*log10(N5+10))^2+
                                             ((2.18/N5^0.4)*(0.4*Fluc95+0.6*R))^2)),
                         N5*(1+sqrt(((2.18/N5^0.4)*(0.4*Fluc95+0.6*R))^2))),
               `L10(A)-L90(A)`=`L10(A)`-`L90(A)`,
               `L(C)-L(A)`=`L10(C)`-`L(A)`) %>%
        #dplyr::select(!c(1,3:6)) %>%
        pivot_longer(cols = !c(1,2),
                     names_to = "Parameters", values_to = "Value") %>%
        pivot_wider(names_from = c("measurement","stimuli.name"),
                    values_from = Value) %>%
        dplyr::mutate(HATS_AIR65dBA.B0=`HATS_AIR['65dB(A)']`-`HATS_AIR['65dB(A)']+B`,
               HATS_AIR65dBA.W0=`HATS_AIR['65dB(A)']`-`HATS_AIR['65dB(A)']+W`,
               HATS_AIR65dBA=`HATS_AIR['65dB(A)']`-`HATS_AIR['65dB(A)']^'*'`,
               HATS_AIR65dBA.B=`HATS_AIR['65dB(A)']`-`HATS_AIR['65dB(A)']^'*'+B`,
               HATS_AIR65dBA.W=`HATS_AIR['65dB(A)']`-`HATS_AIR['65dB(A)']^'*'+W`,
               HATS_AIR70dBA=`HATS_AIR['70dB(A)']`-`HATS_AIR['70dB(A)']^'*'`,
               
               HATS_MRT65dBA.B0=`HATS_MRT['65dB(A)']`-`HATS_MRT['65dB(A)']+B`,
               HATS_MRT65dBA.W0=`HATS_MRT['65dB(A)']`-`HATS_MRT['65dB(A)']+W`,
               HATS_MRT65dBA=`HATS_MRT['65dB(A)']`-`HATS_MRT['65dB(A)']^'*'`,
               HATS_MRT65dBA.B=`HATS_MRT['65dB(A)']`-`HATS_MRT['65dB(A)']^'*'+B`,
               HATS_MRT65dBA.W=`HATS_MRT['65dB(A)']`-`HATS_MRT['65dB(A)']^'*'+W`,
               HATS_MRT70dBA=`HATS_MRT['70dB(A)']`-`HATS_MRT['70dB(A)']^'*'`,
               
               HATS_TRA65dBA.B0=`HATS_TRA['65dB(A)']`-`HATS_TRA['65dB(A)']+B`,
               HATS_TRA65dBA.W0=`HATS_TRA['65dB(A)']`-`HATS_TRA['65dB(A)']+W`,
               HATS_TRA65dBA=`HATS_TRA['65dB(A)']`-`HATS_TRA['65dB(A)']^'*'`,
               HATS_TRA65dBA.B=`HATS_TRA['65dB(A)']`-`HATS_TRA['65dB(A)']^'*'+B`,
               HATS_TRA65dBA.W=`HATS_TRA['65dB(A)']`-`HATS_TRA['65dB(A)']^'*'+W`,
               HATS_TRA70dBA=`HATS_TRA['70dB(A)']`-`HATS_TRA['70dB(A)']^'*'`,
               
               EA_AIR65dBA.B0=`EA_AIR['65dB(A)']`-`EA_AIR['65dB(A)']+B`,
               EA_AIR65dBA.W0=`EA_AIR['65dB(A)']`-`EA_AIR['65dB(A)']+W`,
               EA_AIR65dBA=`EA_AIR['65dB(A)']`-`EA_AIR['65dB(A)']^'*'`,
               EA_AIR65dBA.B=`EA_AIR['65dB(A)']`-`EA_AIR['65dB(A)']^'*'+B`,
               EA_AIR65dBA.W=`EA_AIR['65dB(A)']`-`EA_AIR['65dB(A)']^'*'+W`,
               EA_AIR70dBA=`EA_AIR['70dB(A)']`-`EA_AIR['70dB(A)']^'*'`,
               
               EA_MRT65dBA.B0=`EA_MRT['65dB(A)']`-`EA_MRT['65dB(A)']+B`,
               EA_MRT65dBA.W0=`EA_MRT['65dB(A)']`-`EA_MRT['65dB(A)']+W`,
               EA_MRT65dBA=`EA_MRT['65dB(A)']`-`EA_MRT['65dB(A)']^'*'`,
               EA_MRT65dBA.B=`EA_MRT['65dB(A)']`-`EA_MRT['65dB(A)']^'*'+B`,
               EA_MRT65dBA.W=`EA_MRT['65dB(A)']`-`EA_MRT['65dB(A)']^'*'+W`,
               EA_MRT70dBA=`EA_MRT['70dB(A)']`-`EA_MRT['70dB(A)']^'*'`,
               
               EA_TRA65dBA.B0=`EA_TRA['65dB(A)']`-`EA_TRA['65dB(A)']+B`,
               EA_TRA65dBA.W0=`EA_TRA['65dB(A)']`-`EA_TRA['65dB(A)']+W`,
               EA_TRA65dBA=`EA_TRA['65dB(A)']`-`EA_TRA['65dB(A)']^'*'`,
               EA_TRA65dBA.B=`EA_TRA['65dB(A)']`-`EA_TRA['65dB(A)']^'*'+B`,
               EA_TRA65dBA.W=`EA_TRA['65dB(A)']`-`EA_TRA['65dB(A)']^'*'+W`,
               EA_TRA70dBA=`EA_TRA['70dB(A)']`-`EA_TRA['70dB(A)']^'*'`) %>%
        dplyr::select(!c(2:51)) %>%
        dplyr::mutate(across(!1, round, 2)) %>%
        kableExtra::kbl(booktabs = T, linesep = "",
                        #format = "latex",
                        format = "html",
                        label = "attHATSEA_SV",
                        caption = "Difference between mean acoustic and 
                        psychoacoustic indices before and after intervention, 
                        across both KEMAR HATS and energetic average measurements") %>%
        #kable_styling(latex_table_env = "tabularx") %>%
        kable_paper(full_width = T) %>%
        add_header_above(c(" ", "65dB(A)" = 5, "70dB(A)" = 1, 
                           "65dB(A)" = 5, "70dB(A)" = 1, 
                           "65dB(A)" = 5, "70dB(A)" = 1, 
                           "65dB(A)" = 5, "70dB(A)" = 1, 
                           "65dB(A)" = 5, "70dB(A)" = 1, 
                           "65dB(A)" = 5, "70dB(A)" = 1), bold = T) %>%
        add_header_above(c(" ", "ANC:NO" = 2, "ANC:YES" = 4, 
                           "ANC:NO" = 2, "ANC:YES" = 4, 
                           "ANC:NO" = 2, "ANC:YES" = 4, 
                           "ANC:NO" = 2, "ANC:YES" = 4, 
                           "ANC:NO" = 2, "ANC:YES" = 4, 
                           "ANC:NO" = 2, "ANC:YES" = 4), bold = T) %>%
        add_header_above(c(" ", "Aircraft" = 6, "MRT" = 6, "Traffic" = 6, 
                           "Aircraft" = 6, "MRT" = 6, "Traffic" = 6),
                         bold = T) %>%
        add_header_above(c(" ", "HATS" = 18, 
                           "Energetic Average" = 18), bold = T) #%>%
        #save_kable(paste0(getwd(),"/diffHATSEV_SV.tex"))

table.sv.att
```

### FFT (dBA)

```{r FFTdBA, message=FALSE}

#color
set1clr<-brewer.pal(n = 9,"Set1")

#mean across runs and EA/HATS channels
summary.FFT.dBA.df <- data.l[["data.ffta"]] %>%
        #mean across runs
        group_by(freq,stimuliID) %>%
        dplyr::summarise(across(-c(run),list(meandB))) %>%
        ungroup() %>%
        `colnames<-`(gsub("_1","",colnames(.))) %>% #remove "_1"
        rowwise() %>% #mean across EA/HATS mics
        mutate(EA=meandB(c(mic5,mic13,mic14,mic15,mic17,mic18)),
               HATS=meandB(c(HATS.L,HATS.R))) %>%
        dplyr::select(!c(mic5,mic13,mic14,mic15,mic17,mic18,HATS.L,HATS.R)) %>%
        filter(!stimuliID==0) %>%
        ungroup() %>%
        left_join(.,stimuli.trackInfo.names,by="stimuliID") %>%
        pivot_longer(cols = c(EA,HATS),names_to = "measurement",values_to = "dBA")
        
g.65dBA<-ggplot(data = summary.FFT.dBA.df %>% 
               mutate(stimuliID=as.factor(stimuliID)) %>%
               filter(SPL=="65dB"), 
       aes(x = freq,y = dBA,color=Masker)) +
        facet_grid(NoiseType~measurement) +
        geom_line(aes(linetype=ANC))+
        scale_x_log10(limits=c(100,10000)) +
        annotation_logticks(sides="b") + 
        scale_color_manual(values = set1clr) +
        ylim(20,50) + xlab("Frequency, Hz") + 
        scale_color_manual(values = set1clr) +
        ylab ("Sound Pressure Level, dB(A)") + theme(legend.position="bottom")
g.65dBA

ggsave("./outputs/65dBA_HATS.pdf",plot = g.65dBA, width = 1800, height = 1500, units = "px",scale = 1)

#70 dBA only HATS
g.70dBA<-ggplot(data = summary.FFT.dBA.df %>% 
               mutate(stimuliID=as.factor(stimuliID)) %>%
               filter(SPL=="70dB" & measurement=="HATS"), 
       aes(x = freq,y = dBA,color=NoiseType)) +
        facet_wrap(~NoiseType,nrow = 3) +
        geom_line(aes(linetype=ANC))+
        ylim(24,55) + xlab("Frequency, Hz") + 
        scale_color_manual(values = set1clr) +
        ylab ("Sound Pressure Level, dB(A)") +
        scale_x_log10(limits=c(100,10000)) +
        annotation_logticks(sides="b") +
        theme(legend.position="none",panel.grid.minor = element_blank())
g.70dBA
ggsave("./outputs/70dBA_HATS.pdf",plot = g.70dBA, width = 900, height = 1500, units = "px",scale = 1)
```

### FFT (dBC)

```{r FFT, message=FALSE}

#color
set1clr<-brewer.pal(n = 9,"Set1")

#mean across runs and EA/HATS channels
summary.FFT.dBC.df <- data.l[["data.fftc"]] %>%
        #mean across runs
        group_by(freq,stimuliID) %>%
        dplyr::summarise(across(-c(run),list(meandB))) %>%
        ungroup() %>%
        `colnames<-`(gsub("_1","",colnames(.))) %>% #remove "_1"
        rowwise() %>% #mean across EA/HATS mics
        mutate(EA=meandB(c(mic5,mic13,mic14,mic15,mic17,mic18)),
               HATS=meandB(c(HATS.L,HATS.R))) %>%
        dplyr::select(!c(mic5,mic13,mic14,mic15,mic17,mic18,HATS.L,HATS.R)) %>%
        filter(!stimuliID==0) %>%
        ungroup() %>%
        left_join(.,stimuli.trackInfo.names,by="stimuliID") %>%
        pivot_longer(cols = c(EA,HATS),names_to = "measurement",values_to = "dBC")
        
g.65dBC<-ggplot(data = summary.FFT.dBC.df %>% 
               mutate(stimuliID=as.factor(stimuliID)) %>%
               filter(SPL=="65dB"), 
       aes(x = freq,y = dBC,color=Masker)) +
        facet_grid(NoiseType~measurement) +
        geom_line(aes(linetype=ANC))+
        scale_x_log10(limits=c(100,10000)) +
        annotation_logticks(sides="b") + 
        scale_color_manual(values = set1clr) +
        ylim(20,50) + xlab("Frequency, Hz") + 
        scale_color_manual(values = set1clr) +
        ylab ("Sound Pressure Level, dB(C)") + theme(legend.position="bottom")
g.65dBC

ggsave("./outputs/65dBC_HATS.pdf",plot = g.65dBC, width = 1800, height = 1500, units = "px",scale = 1)

#70 dBA only HATS
g.70dBC<-ggplot(data = summary.FFT.dBC.df %>% 
               mutate(stimuliID=as.factor(stimuliID)) %>%
               filter(SPL=="70dB" & measurement=="HATS"), 
       aes(x = freq,y = dBC,color=NoiseType)) +
        facet_wrap(~NoiseType,nrow = 3) +
        geom_line(aes(linetype=ANC))+
        ylim(24,55) + xlab("Frequency, Hz") + 
        scale_color_manual(values = set1clr) +
        ylab ("Sound Pressure Level, dB(C)") +
        scale_x_log10(limits=c(100,10000)) +
        annotation_logticks(sides="b") +
        theme(legend.position="none",panel.grid.minor = element_blank())
g.70dBC
ggsave("./outputs/70dBC_HATS.pdf",plot = g.70dBC, width = 900, height = 1500, units = "px",scale = 1)

#create combined plot of 70dBA and 70dBC

#70 dBA only HATS
g.70dBC_legend<-ggplot(data = summary.FFT.dBC.df %>% 
               mutate(stimuliID=as.factor(stimuliID)) %>%
               filter(SPL=="70dB" & measurement=="HATS"), 
       aes(x = freq,y = dBC,color=NoiseType)) +
        facet_wrap(~NoiseType,nrow = 3) +
        geom_line(aes(linetype=ANC))+
        ylim(24,55) + xlab("Frequency, Hz") + 
        scale_color_manual(values = set1clr) +
        ylab ("Sound Pressure Level, dB(C)") +
        scale_x_log10(limits=c(100,10000)) +
        annotation_logticks(sides="b") +
        theme(legend.position="bottom",panel.grid.minor = element_blank())

# Create user-defined function, which extracts legends from ggplots
extract_legend <- function(my_ggp) {
  step1 <- ggplot_gtable(ggplot_build(my_ggp))
  step2 <- which(sapply(step1$grobs, function(x) x$name) == "guide-box")
  step3 <- step1$grobs[[step2]]
  return(step3)
}

# Apply user-defined function to extract legend
shared_legend <- extract_legend(g.70dBC_legend)

# combine plots with shared legend
g.comb.70dB<-grid.arrange(arrangeGrob(g.70dBA, g.70dBC, ncol = 2),
             shared_legend, nrow = 2, heights = c(20, 1))

ggsave("./outputs/70dB_HATS_comb.pdf",plot = g.comb.70dB, width = 1800, height = 1500, units = "px",scale = 1)

```

## Circumplexity analysis

The circumplexity of the PAQ attributes are evaluated via the randomized test of hypothesized order relations (RTHOR) and sinusoidality. The correspondence index (CI) indicates an 86% circumplexity fit (p<0.001).

```{r circum, message=FALSE}

#Check for circumplexity using RTHORR

#Pearson's correlation
cor.PAQ <- cor(data.subj.rel %>% dplyr::select(eventful:chaotic),method = "pearson")

#RTHOR
randmf_output <- RTHORR::randmf_from_df(
  df_list = list(cor.PAQ,cor.PAQ),
  ord = "circular8")
paste0("Circumplexity fit: ",round(randmf_output$RTHOR$CI[1]*100,2),"%")

#PCA
pca.PAQ<-principal(data.subj.rel %>% 
                           dplyr::select(eventful:chaotic),
                   nfactors = 2,rotate = "none")

#as.data.frame.matrix(pca.PAQ$loadings)

#Generate latex table
cor.PAQ %>%
        cbind(.,as.data.frame.matrix(pca.PAQ$loadings)) %>%
        mutate(across(1:10, round, 2)) %>%
        as.data.frame(.) %>%
        mutate(vibrant=replace(vibrant, eventful==1.00, "$P_1$"),
               pleasant=replace(pleasant,vibrant==1.00, "$P_1$"),
               pleasant=replace(pleasant,eventful==1.00, "$P_2$"),
               calm=replace(calm,eventful==1.00, "$P_3$"),
               calm=replace(calm,vibrant==1.00, "$P_2$"),
               calm=replace(calm,pleasant==1.00, "$P_1$"),
               uneventful=replace(uneventful,eventful==1.00, "$P_4$"),
               uneventful=replace(uneventful,vibrant==1.00, "$P_3$"),
               uneventful=replace(uneventful,pleasant==1.00, "$P_2$"),
               uneventful=replace(uneventful,calm==1.00, "$P_1$"),
               monotonous=replace(monotonous,eventful==1.00, "$P_3$"),
               monotonous=replace(monotonous,vibrant==1.00, "$P_4$"),
               monotonous=replace(monotonous,pleasant==1.00, "$P_3$"),
               monotonous=replace(monotonous,calm==1.00, "$P_2$"),
               monotonous=replace(monotonous,uneventful==1.00, "$P_1$"),
               annoying=replace(annoying,eventful==1.00, "$P_2$"),
               annoying=replace(annoying,vibrant==1.00, "$P_3$"),
               annoying=replace(annoying,pleasant==1.00, "$P_4$"),
               annoying=replace(annoying,calm==1.00, "$P_3$"),
               annoying=replace(annoying,uneventful==1.00, "$P_2$"),
               annoying=replace(annoying,monotonous==1.00, "$P_1$"),
               chaotic=replace(chaotic,eventful==1.00, "$P_1$"),
               chaotic=replace(chaotic,vibrant==1.00, "$P_2$"),
               chaotic=replace(chaotic,pleasant==1.00, "$P_3$"),
               chaotic=replace(chaotic,calm==1.00, "$P_4$"),
               chaotic=replace(chaotic,uneventful==1.00, "$P_3$"),
               chaotic=replace(chaotic,monotonous==1.00, "$P_2$"),
               chaotic=replace(chaotic,annoying==1.00, "$P_1$"))%>%
        kableExtra::kbl(booktabs = T, linesep = "",
                        format = "html",
                        label = "corPCA",
                        caption = "Pearson's correlation and principal component
                        analysis loadings of PAQ attributes") %>%
        #kable_styling(latex_table_env = "tabularx") %>%
        kable_paper(full_width = T) %>%
        add_header_above(c(" ", "Pearson's Correlation" = 8, 
                           "Loadings" = 2), bold = T) #%>%
        #save_kable(paste0(getwd(),"/corPCA.tex"))

```

## Three way anova analysis

### Loudness (traffic, aircraft, MRT)

- normality test
- non-normal -> ART ANOVA

```{r}
#mean scores for ANC
meanLoudnessANC <- data.subj.rel %>%
        filter(Masker=="None") %>%
        group_by(NoiseType, SPL, ANC) %>%
        summarize(mean_loud=mean(loudness),
                  logmean=10^mean(log10(loudness)))

#normality test
loudness.air.65dB <- data.subj.rel %>% 
        dplyr::filter(SPL=="65dB" & NoiseType=="Aircraft") %>% 
        dplyr::select(loudness)
loudness.mrt.65dB <- data.subj.rel %>% 
        dplyr::filter(SPL=="65dB" & NoiseType=="Train") %>% 
        dplyr::select(loudness)
loudness.tra.65dB <- data.subj.rel %>% 
        dplyr::filter(SPL=="65dB" & NoiseType=="Traffic") %>% 
        dplyr::select(loudness)

shapiro.test(x = loudness.air.65dB$loudness)
shapiro.test(x = loudness.mrt.65dB$loudness)
shapiro.test(x = loudness.tra.65dB$loudness)

#Aligned Rank Transformed ANOVA

data.air<-data.subj.rel %>% dplyr::filter(SPL=="65dB" & NoiseType=="Aircraft")
m.art.air = ARTool::art(loudness ~ Masker * ANC + (1|ID),
                        data=data.air) 
# linear mixed model syntax; see lme4::lmer
anova(m.art.air)

data.mrt<-data.subj.rel %>% dplyr::filter(SPL=="65dB" & NoiseType=="Train")
m.art.mrt = ARTool::art(loudness ~ Masker * ANC + (1|ID),
                        data=data.mrt) 
# linear mixed model syntax; see lme4::lmer
anova(m.art.mrt)

data.tra<-data.subj.rel %>% dplyr::filter(SPL=="65dB" & NoiseType=="Traffic")
m.art.tra = ARTool::art(loudness ~ Masker * ANC + (1|ID),
                        data=data.tra) 
# linear mixed model syntax; see lme4::lmer
anova(m.art.tra)

#ART Effects sizes using Cohen's d
#https://cran.r-project.org/web/packages/ARTool/vignettes/art-effect-size.html#cohens-d
m.linear.air <- lm(loudness ~ Masker * ANC, data=data.air)
#PC with ANC conditions
ANC.contrasts.air <- summary(art.con(m.art.air, "ANC",adjust = "bonferroni"))
ANC.contrasts.air$d = ANC.contrasts.air$estimate / car::sigmaHat(m.linear.air)
ANC.contrasts.air
#PC with Maskers
Masker.contrasts.air <- summary(art.con(m.art.air, "Masker",adjust = "bonferroni"))
Masker.contrasts.air$d <- Masker.contrasts.air$estimate / car::sigmaHat(m.linear.air)
Masker.contrasts.air


m.linear.mrt <- lm(loudness ~ Masker * ANC, data=data.mrt)
#PC with ANC conditions
ANC.contrasts.mrt <- summary(art.con(m.art.mrt, "ANC",adjust = "bonferroni"))
ANC.contrasts.mrt$d = ANC.contrasts.mrt$estimate / car::sigmaHat(m.linear.mrt)
ANC.contrasts.mrt
#PC with Maskers
Masker.contrasts.mrt <- summary(art.con(m.art.mrt, "Masker",adjust = "bonferroni"))
Masker.contrasts.mrt$d <- Masker.contrasts.mrt$estimate / car::sigmaHat(m.linear.mrt)
Masker.contrasts.mrt


m.linear.tra <- lm(loudness ~ Masker * ANC, data=data.tra)
#PC with ANC conditions
ANC.contrasts.tra <- summary(art.con(m.art.tra, "ANC",adjust = "bonferroni"))
ANC.contrasts.tra$d = ANC.contrasts.tra$estimate / car::sigmaHat(m.linear.tra)
ANC.contrasts.tra
#PC with Maskers
Masker.contrasts.tra <- summary(art.con(m.art.tra, "Masker",adjust = "bonferroni"))
Masker.contrasts.tra$d <- Masker.contrasts.tra$estimate / car::sigmaHat(m.linear.tra)
Masker.contrasts.tra

#Generate table of ART ANOVA statistics for loudness
#art anova main effect
loudness.art.anova.stats <- 
        rbind(as.data.frame(anova(m.art.air)) %>% 
                      mutate(`Variable`="AIR",d="",Test="2W-ART ANOVA"),
              as.data.frame(anova(m.art.mrt)) %>% 
                      mutate(`Variable`="MRT",d="",Test="2W-ART ANOVA"),
              as.data.frame(anova(m.art.tra)) %>% 
                      mutate(`Variable`="TRA",d="",Test="2W-ART ANOVA")) %>%
        dplyr::select(-`F`,-Df,-Df.res) %>%
        `colnames<-`(c("Term","p-value","Variable","d","Test"))
#contrast tests for masker
loudness.art.anova.contrast.masker <- 
        rbind(as.data.frame(Masker.contrasts.air) %>% 
                      mutate(Variable="AIR",Test="ART Contrast"),
              as.data.frame(Masker.contrasts.mrt) %>% 
                      mutate(Variable="MRT",Test="ART Contrast"),
              as.data.frame(Masker.contrasts.tra) %>% 
                      mutate(Variable="TRA",Test="ART Contrast")) %>%
                dplyr::select(-estimate, -SE, -df, -t.ratio) %>%
                `colnames<-`(c("Term","p-value","d","Variable","Test"))

#contrast tests for masker
loudness.art.anova.contrast.anc <- 
        rbind(as.data.frame(ANC.contrasts.air) %>% 
                      mutate(Variable="AIR",Test="ART Contrast"),
              as.data.frame(ANC.contrasts.mrt) %>% 
                      mutate(Variable="MRT",Test="ART Contrast"),
              as.data.frame(ANC.contrasts.tra) %>% 
                      mutate(Variable="TRA",Test="ART Contrast")) %>%
                dplyr::select(-estimate, -SE, -df, -t.ratio) %>%
                `colnames<-`(c("Term","p-value","d","Variable","Test"))
        
loudness.art.anova.stats.tbl <- 
        rbind(loudness.art.anova.stats[1,],
              loudness.art.anova.contrast.masker %>% filter(Variable=="AIR"),
              loudness.art.anova.stats[2,],
              loudness.art.anova.contrast.anc %>% filter(Variable=="AIR"),
              loudness.art.anova.stats[3:4,],
              loudness.art.anova.contrast.masker %>% filter(Variable=="MRT"),
              loudness.art.anova.stats[5,],
              loudness.art.anova.contrast.anc %>% filter(Variable=="MRT"),
              loudness.art.anova.stats[6:7,],
              loudness.art.anova.contrast.masker %>% filter(Variable=="TRA"),
              loudness.art.anova.stats[8,],
              loudness.art.anova.contrast.anc %>% filter(Variable=="TRA"),
              loudness.art.anova.stats[9,]) %>%
        #rounding
        mutate(d=as.numeric(d)) %>%
        mutate(across(c("p-value","d"),round,4)) %>%
        mutate(`p-value`=format(`p-value`),
               `p-value`=ifelse(as.numeric(`p-value`)<0.0001,
                                paste0(`p-value`,"****"),
                        ifelse(as.numeric(`p-value`)<0.001,
                               paste0(`p-value`,"***"),
                               ifelse(as.numeric(`p-value`)<0.01,
                                      paste0(`p-value`,"**"),
                                      ifelse(as.numeric(`p-value`)<0.05,
                                             paste0(`p-value`,"*"),`p-value`)))),
               d=ifelse(is.na(d),"",d)) %>%
        relocate(c("Variable","Term","Test")) %>%
        `rownames<-`(NULL) %>%
        kableExtra::kbl(booktabs = T, linesep = "",
                        #row.names = NULL,
                        #format = "latex",
                        format = "html",
                        label = "PLNANOVAstats",
                        caption = "Summary of 2W-ART ANOVA, and relevant post-hoc 
                        ART constrast tests for PLN.") %>%
        #kable_styling(latex_table_env = "tabularx") %>%
        kable_paper(full_width = T) %>%
        collapse_rows(columns = 2, valign = "top") %>%
        footnote(general = "*:p<0.05, **:p<0.01, ***:p<0.001, ****:p<0.0001") #%>%
        #save_kable(paste0(getwd(),"/PLNANOVAstats.tex"))
loudness.art.anova.stats.tbl        
```

### PAQ 3WMANOVA

```{r PAQ,message=FALSE}

#ISO pleasant, ISO eventful

data.subj.rel <- data.subj.rel %>%
        #ISO 12913-3 normalise by (100+sqrt(20000))
        mutate(ISOPL=((pleasant-annoying)+cospi(0.25)*(calm-chaotic)+cospi(0.25)*(vibrant-monotonous))/(100+sqrt(20000))) %>%
        mutate(ISOEV=((eventful-uneventful)+cospi(0.25)*(chaotic-calm)+cospi(0.25)*(vibrant-monotonous))/(100+sqrt(20000)))

##three-way anova

ISOPLModel <- aov(ISOPL ~ NoiseType * Masker * ANC, 
                  data=data.subj.rel %>% filter(SPL=="65dB"))
summary(ISOPLModel)

ISOPLModel1<-update(ISOPLModel, . ~ . -NoiseType:Masker:ANC)
summary(ISOPLModel1)

etaSquared(ISOPLModel)

pcISOPL<-TukeyHSD(ISOPLModel)

#check for and remove non-complete cases
dataRelComp <- data.subj.rel %>% filter(complete.cases(.))

#annoycatModel <- aov(annoycat ~ NoiseType * Masker * ANC, 
#                     data=dataRelComp %>% filter(SPL=="65dB"))
#summary(annoycatModel)

#mean scores
mean65dB <- data.subj.rel %>%
        filter(SPL=="65dB") %>%
        group_by(NoiseType, Masker, ANC) %>%
        summarize(mu.ISOPL=mean(ISOPL),
                  mu.ISOEV=mean(ISOEV))

```

### ISOPL & ISOEV 3WMANOVA

```{r isoplev3wanova}

#test for normality
MVN::mvn(data = data.subj.rel %>% 
                 dplyr::select(c(ISOPL,ISOEV)),
         mvnTest = "mardia",multivariatePlot = "qq",desc = T)

#three way manova
ISOPLEV.res.man<-manova(cbind(ISOPL,ISOEV) ~ NoiseType * Masker * ANC, 
                        data=data.subj.rel %>% filter(SPL=="65dB"))

#convert to manova object to dataframe with broom
ISOPLEV.man.stat<-tidy(ISOPLEV.res.man) %>%
        filter(term!="Residuals") %>%
        dplyr::select(!c("df","pillai","statistic","num.df","den.df"))

#effect size
ISOPLEV.man.stat.eff<-as.data.frame(effectsize::eta_squared(ISOPLEV.res.man)) %>% 
                          dplyr::select(c("Parameter","Eta2_partial")) %>% 
                          `colnames<-`(c("term","Eta2_partial"))

#homogenity of variance assumption
grouped.data <- data.subj.rel %>% 
        filter(SPL=="65dB") %>%
        gather(key = "variable", value = "value", ISOPL, ISOEV) %>%
  group_by(variable)
grouped.data %>% rstatix::levene_test(value ~ NoiseType * Masker * ANC)

# #univariate anova
# ISOPLEV.3Wanova.stat<-as.data.frame(grouped.data %>% rstatix::anova_test(value ~ NoiseType*Masker*ANC,
#                                      effect.size = "pes")) %>%
#         dplyr::select(-DFn,-DFd,-`F`) %>%
#         mutate(across(c("p","pes"),round,4)) %>%
#         mutate(p=format(p)) %>% #convert to string keeping decimals
#         unite(`p-value`,c("p","p<.05"),sep = "") %>% #concat
#         `colnames<-`(c("Variable","Term","p-value","pes"))
# 
# #pairwise comparisons with Tukey HSD
# ISOEV.tukeyHSD.stat<-dataRel %>% filter(SPL=="65dB") %>%
#          dplyr::select(c(NoiseType,Masker,ISOEV)) %>% #only noise type and masker
#         rstatix::tukey_hsd(ISOEV ~ NoiseType+Masker) %>%
#         mutate(p.adj=round(p.adj,4),
#                Variable="ISOEV") %>%
#         unite(Term,c("group1","group2"),sep = "--") %>%
#         mutate(p.adj.signif=ifelse(p.adj.signif=="ns","",p.adj.signif)) %>% #remove ns
#         mutate(p.adj=format(p.adj)) %>% #convert to string keeping decimals
#         unite(`p-value`,c("p.adj","p.adj.signif"),sep = "") %>%
#         dplyr::select(-null.value,-estimate,-conf.low,-conf.high)
# 
# ISOPL.tukeyHSD.stat<-dataRel %>% filter(SPL=="65dB") %>%
#          dplyr::select(c(NoiseType,Masker,ANC,ISOEV)) %>%
#         rstatix::tukey_hsd(ISOEV ~ NoiseType*Masker+ANC) %>%
#         mutate(p.adj=round(p.adj,4),
#                Variable="ISOPL") %>%
#         filter(term!="NoiseType") %>%
#         unite(Term,c("group1","group2"),sep = "--") %>%
#         mutate(p.adj.signif=ifelse(p.adj.signif=="ns","",p.adj.signif)) %>% #remove ns
#         mutate(p.adj=format(p.adj)) %>% #convert to string keeping decimals
#         unite(`p-value`,c("p.adj","p.adj.signif"),sep = "") %>%
#         dplyr::select(-null.value,-estimate,-conf.low,-conf.high)

#Compute ANOVA with pEta2 eff; and posthoc tukey HSD (emmeans+tukey) with cohen's d eff
ISOPL.anovaPH.stat<-data.subj.rel %>% filter(SPL=="65dB") %>%
         dplyr::select(c(NoiseType,Masker,ANC,ISOPL)) %>%
        jmv::ANOVA(formula = ISOPL ~ NoiseType*Masker*ANC,
                data = ., effectSize = "partEta",
                #only main eff significant variables
                postHoc = ~ Masker+ANC+NoiseType:Masker, 
                   postHocCorr = list("tukey"),
                postHocES = "d")

ISOEV.anovaPH.stat<-data.subj.rel %>% filter(SPL=="65dB") %>%
         dplyr::select(c(NoiseType,Masker,ANC,ISOEV)) %>%
        jmv::ANOVA(formula = ISOEV ~ NoiseType*Masker*ANC,
                data = ., effectSize = "partEta",
                #only main eff significant variables
                postHoc = ~ Masker+NoiseType, 
                   postHocCorr = list("tukey"),
                postHocES = "d")

# 3WANOVA main effect statistics
ISOPLEV.anovaMain.stat<-rbind(as.data.frame(ISOPL.anovaPH.stat$main) %>%
                                      mutate(Variable="ISOPL"),
                              as.data.frame(ISOEV.anovaPH.stat$main) %>%
                                      mutate(Variable="ISOEV")) %>%
        filter(!name %in% c("Residuals")) %>% #remove not needed
        dplyr::select(-ss,-df,-ms,-`F`) %>%
        mutate(across(c("p","etaSqP"),round,4),
               p=format(p),
               p=ifelse(as.numeric(p)<0.0001,paste0(p,"****"),
                        ifelse(as.numeric(p)<0.001,paste0(p,"***"),
                               ifelse(as.numeric(p)<0.01,paste0(p,"**"),
                                      ifelse(as.numeric(p)<0.05,
                                             paste0(p,"*"),p))))) %>%
        `colnames<-`(c("Term","p-value","Effect","Variable")) %>%
        `rownames<-`(NULL) %>%
        mutate(Test="3WANOVA")

#postHoc paired comparisons; Masker, ANC, NoiseType:Masker
ISOPLEV.anovaPH.stat.pc<-rbind(
        #ISOPL masker
        as.data.frame(ISOPL.anovaPH.stat$postHoc[[1]]) %>% 
        mutate(Term=paste0(Masker1,"--",Masker2),
               preTerm="Masker",Variable="ISOPL") %>%
        dplyr::select(!c("Masker1","sep","Masker2")),
        #ISOPL ANC
        as.data.frame(ISOPL.anovaPH.stat$postHoc[[2]]) %>% 
        mutate(Term=paste0(ANC1,"--",ANC2),
               preTerm="ANC",Variable="ISOPL") %>%
        dplyr::select(!c("ANC1","sep","ANC2")),
        #ISOPL NoiseType:Masker
        as.data.frame(ISOPL.anovaPH.stat$postHoc[[3]]) %>% 
        mutate(Term=paste0(NoiseType1,",",Masker1,"--"
                           ,NoiseType2,",",Masker2),
               preTerm="Noise Type:Masker",Variable="ISOPL") %>%
        dplyr::select(!c("NoiseType1","NoiseType2","sep","Masker1","Masker2")),
        #ISOEV NoiseType
        as.data.frame(ISOEV.anovaPH.stat$postHoc[[2]]) %>% 
        mutate(Term=paste0(NoiseType1,"--",NoiseType2),
               preTerm="Noise Type",Variable="ISOEV") %>%
        dplyr::select(!c("NoiseType1","NoiseType2","sep")),
        #ISOEV Masker
        as.data.frame(ISOEV.anovaPH.stat$postHoc[[1]]) %>% 
        mutate(Term=paste0(Masker1,"--",Masker2),
               preTerm="Masker",Variable="ISOEV") %>%
        dplyr::select(!c("Masker1","Masker2","sep"))) %>%
        dplyr::select(-df,-t) %>%
        mutate(across(c("ptukey","d","md","se"),round,4),
               ptukey=format(ptukey),
               ptukey=ifelse(as.numeric(ptukey)<0.0001,paste0(ptukey,"****"),
                        ifelse(as.numeric(ptukey)<0.001,paste0(ptukey,"***"),
                               ifelse(as.numeric(ptukey)<0.01,paste0(ptukey,"**"),
                                      ifelse(as.numeric(ptukey)<0.05,paste0(ptukey,"*"),ptukey))))) %>%
        mutate(Test="Tukey HSD") %>%
        `colnames<-`(c("md","se","p-value","Effect","Term","preTerm","Variable","Test"))
        
# #Effect size (Cohen's d) for pairwise comparisons
# ISOEV.tukeyHSD.stat.eff <- dataRel %>% filter(SPL=="65dB") %>%
#          dplyr::select(c(NoiseType,Masker,ISOEV)) %>% #only noise type and masker
#         rstatix::cohens_d(ISOEV ~ NoiseType,paired = T)
#         effectsize::cohens_d(ISOEV ~ NoiseType|Masker,data=.,paired = T)

#generate table of 3wmanova
ISOPLEV.man.stat.tbl<-ISOPLEV.man.stat %>% 
        left_join(.,ISOPLEV.man.stat.eff) %>%
        mutate(Test="3WMANOVA", Variable="ISOPL:ISOEV") %>%
        `colnames<-`(c("Term","p-value","Effect","Test","Variable")) %>%
        mutate(across(c("p-value","Effect"),round,4)) %>%
        mutate(`p-value`=format(`p-value`),
                `p-value`=ifelse(as.numeric(`p-value`)<0.0001,
                                 paste0(`p-value`,"****"),
                                 ifelse(as.numeric(`p-value`)<0.001,
                                        paste0(`p-value`,"***"),
                               ifelse(as.numeric(`p-value`)<0.01,
                                      paste0(`p-value`,"**"),
                                      ifelse(as.numeric(`p-value`)<0.05,
                                             paste0(`p-value`,"*"),`p-value`)))))

#generate combined table with 3WMANOVA, 3WANOVA, Tukey HSD
ISOPLEV.comb.stat <- rbind(ISOPLEV.man.stat.tbl, 
                               #ISOPL NoiseType
                               ISOPLEV.anovaMain.stat[1,],
                               #ISOPL Masker
                               ISOPLEV.anovaMain.stat[2,],
                               #ISOPL Masker PH
                               ISOPLEV.anovaPH.stat.pc %>%
                                       filter(Variable=="ISOPL" &
                                                      preTerm=="Masker") %>%
                                       dplyr::select(-md,-se,-preTerm),
                               #ISOPL ANC
                               ISOPLEV.anovaMain.stat[3,],
                               #ISOPL Masker PH
                               ISOPLEV.anovaPH.stat.pc %>%
                                       filter(Variable=="ISOPL" & preTerm=="ANC") %>%
                                       dplyr::select(-md,-se,-preTerm),
                               #ISOPL NoiseType:Masker
                               ISOPLEV.anovaMain.stat[4,],
                               #ISOPL NoiseType:Masker PH
                               ISOPLEV.anovaPH.stat.pc %>%
                                       filter(Variable=="ISOPL" & preTerm=="Noise Type:Masker") %>%
                                       dplyr::select(-md,-se,-preTerm),
                               #ISOPL rest of interaction effects 3WANOVA
                               #ISOEV Noise Type
                               ISOPLEV.anovaMain.stat[5:8,],
                               #ISOEV Noise Type PH
                               ISOPLEV.anovaPH.stat.pc %>%
                                       filter(Variable=="ISOEV" & preTerm=="Noise Type") %>%
                                       dplyr::select(-md,-se,-preTerm),
                               #ISOEV Masker
                               ISOPLEV.anovaMain.stat[9,],
                               #ISOEV Masker PH
                               ISOPLEV.anovaPH.stat.pc %>%
                                       filter(Variable=="ISOEV" & preTerm=="Masker") %>%
                                       dplyr::select(-md,-se,-preTerm),
                               ISOPLEV.anovaMain.stat[10:14,]) %>%
        relocate(c("Variable","Term","Test"))
        

ISOPLEV.comb.stat.tbl <- ISOPLEV.comb.stat %>%
        `rownames<-`(NULL) %>%
        kableExtra::kbl(booktabs = T, linesep = "",
                        #row.names = NULL,
                        #format = "latex",
                        format = "html",
                        label = "PAQANOVAstats",
                        caption = "Summary of 3WMANOVA, post-hoc univariate 3WANOVA, and relevant post-hoc 
                        Tukey HSD tests for ISOPL and ISOEV. ") %>%
        #kable_styling(latex_table_env = "tabularx") %>%
        kable_paper(full_width = T) %>%
        collapse_rows(columns = 1, valign = "top") %>%
        footnote(general = "*:p<0.05, **:p<0.01, ***:p<0.001, ****:p<0.0001") #%>%
        #save_kable(paste0(getwd(),"/PAQANOVAstats.tex"))

ISOPLEV.comb.stat.tbl
```


## PAQ 2D density plots

```{r PAQ2D}

#define color palette for density plot using pal package
densityClr<-census.blueyellow()[c(3,6,9)]

#aircraft
g.2Dden.air<-ggplot(
        data=data.subj.rel %>% 
                dplyr::filter(NoiseType=="Aircraft"& SPL=="65dB"),
        aes(x = ISOPL, y = ISOEV, group = Masker)) +
        #facet_wrap(~ANC)+
        geom_point(aes(group = Masker,color=Masker),alpha=0.3) +
        stat_density_2d(geom = "polygon", aes(alpha = ..level..,
                                              fill = Masker),
                  bins = 5) +
        scale_fill_manual(values = densityClr) +
        scale_color_manual(values = densityClr) +
        xlim(c(-1,1)) + ylim(c(-1,1)) + 
        ylab(expression(italic(E))) +
        xlab(expression(italic(P))) + 
        theme(legend.position = "left",legend.box="vertical")

#add density plot at margins
g.2Dden.air.marg<-ggMarginal(g.2Dden.air,groupColour = T,
                             groupFill = T)
g.2Dden.air.marg
ggsave("./outputs/2DISO_Aircraft.pdf",plot = g.2Dden.air.marg, width = 2000, height = 1700, units = "px",scale = 1)

#train
g.2Dden.train<-ggplot(data=data.subj.rel %>% filter(NoiseType=="Train"& SPL=="65dB"), 
       aes(x = ISOPL, y = ISOEV, group = Masker)) +
        #facet_wrap(~ANC)+
        geom_point(aes(group = Masker,color=Masker),alpha=0.3) +
        stat_density_2d(geom = "polygon", aes(alpha = ..level..,
                                              fill = Masker),
                  bins = 5) +
        scale_fill_manual(values = densityClr) +
        scale_color_manual(values = densityClr) +
        xlim(c(-1,1)) + ylim(c(-1,1)) +
        xlab(expression(italic(P))) + 
        ylab(expression(italic(E))) +
        theme(legend.position = "left",legend.box="vertical")

#add density plot at margins
g.2Dden.train.marg<-ggMarginal(g.2Dden.train,groupColour = T,groupFill = T)
g.2Dden.train.marg
ggsave("./outputs/2DISO_Train.pdf",plot = g.2Dden.train.marg, width = 2000, height = 1700, units = "px",scale = 1)

#traffic
g.2Dden.traffic<-ggplot(data=data.subj.rel %>% filter(NoiseType=="Traffic" & SPL=="65dB"), 
       aes(x = ISOPL, y = ISOEV, group = Masker)) +
        #facet_wrap(~ANC)+
        geom_point(aes(color=Masker,group = Masker,),alpha=0.3) +
        stat_density_2d(geom = "polygon", aes(alpha = stat(level),
                                              fill = Masker,
                                              group = Masker),
                  bins = 4,contour_var = "ndensity",n=80) + #normalised density
        scale_fill_manual(values = densityClr) +
        scale_color_manual(values = densityClr) +
        xlim(c(-1,1)) + ylim(c(-1,1)) +
        xlab(expression(italic(P))) + 
        ylab(expression(italic(E))) +
        theme(legend.position = "left",legend.box="vertical")


#add density plot at margins
g.2Dden.traffic.marg<-ggMarginal(g.2Dden.traffic,groupColour = T,groupFill = T)
g.2Dden.traffic.marg
ggsave("./outputs/2DISO_Traffic.pdf",plot = g.2Dden.traffic.marg, width = 2000, height = 1700, units = "px",scale = 1)
```


## Annoyance

### Degree of agreement

```{r}

#65 dB stimuli only
data.annoy<-data.subj.rel %>%
        dplyr::select(1:5,c("annoycat","annoyscale","annoying")) %>%
        #dplyr::filter(SPL=="65dB") %>%
        mutate(Masker=ifelse(Masker=="Bird","B",
                             ifelse(Masker=="Water","W",as.character(Masker))),
               NoiseType=ifelse(NoiseType=="Aircraft","AIR",
                                ifelse(NoiseType=="Train","MRT","TRA"))) 

n.stimuliID<-length(unique(data.annoy$ID))

#t-distribution at 95% Conf Lvl
td<-qt(0.975,df=n.stimuliID-1)

data.annoy.BA<- data.annoy %>%        
        #upscale categorical scale to 0 t0 100
        dplyr::mutate(NoiseType=factor(NoiseType, levels=c("AIR","MRT","TRA")),
               Masker=factor(Masker, levels = c("None","W","B")),
                annoycat=factor(annoycat, 
                                  levels=c("Not At All","Slightly","Moderately",
                                           "Very","Extremely")),
               annoycatInt=(as.numeric(annoycat)-1)*25) %>%
        #compute average and difference
        dplyr::mutate(annoyMean=rowMeans(dplyr::select(.,c("annoycatInt","annoyscale")),na.rm = T),
               annoyDiff=annoycatInt-annoyscale) %>%
        group_by(SPL,NoiseType,Masker,ANC) %>%
        #mean of differences
        dplyr::mutate(m.annoyDiff=mean(annoyDiff,na.rm = T), 
               #lwr bound for mean
               m.lwr.annoyDiff=m.annoyDiff-
                       td*sd(annoyDiff,na.rm = T)/sqrt(n.stimuliID), 
               #upr bound for mean
               m.upr.annoyDiff=m.annoyDiff+
                       td*sd(annoyDiff,na.rm = T)/sqrt(n.stimuliID)) %>%
        #lower limits of agreement (LoA)
        dplyr::mutate(lwr.annoyDiff=m.annoyDiff-1.96*sd(annoyDiff,na.rm = T),
               lwr.lwr.annoyDiff=lwr.annoyDiff-
                       td*sqrt((1/n.stimuliID + 3.8416/(2*(n.stimuliID-1)))),
               lwr.upr.annoyDiff=lwr.annoyDiff+
                       td*sqrt((1/n.stimuliID + 3.8416/(2*(n.stimuliID-1))))) %>%
        #upper limits of agreement (LoA)
        dplyr::mutate(upr.annoyDiff=m.annoyDiff+1.96*sd(annoyDiff,na.rm = T),
               upr.lwr.annoyDiff=upr.annoyDiff-
                       td*sqrt((1/n.stimuliID + 3.8416/(2*(n.stimuliID-1)))),
               upr.upr.annoyDiff=upr.annoyDiff+
                       td*sqrt((1/n.stimuliID + 3.8416/(2*(n.stimuliID-1))))) %>%
        dplyr::arrange(SPL,NoiseType,Masker,ANC,by_groups=TRUE)

#Bland-altman between annoyscale and annoycat 0 to 100

geom.text.size<-4
theme.size<-16
geom.point.size<-4

g.BA.65dB<-baplotOpts(data = data.annoy.BA %>% filter(SPL=="65dB"),
           X = annoyMean, Y = annoyDiff, color = Masker,
           fg.XY = as.formula(NoiseType~Masker+ANC), np = seq( from=1 , to=18*40 , by=40),
           #hline for mean diff, upper LoA, lower LoA
           hl.mean=m.annoyDiff, hl.upper=upr.annoyDiff, hl.lower=lwr.annoyDiff,
           #lower/upper 95% limits of lwr/upr LoA & mean
           lwr.ymin=lwr.lwr.annoyDiff,lwr.ymax=lwr.upr.annoyDiff,
           upr.ymin=upr.lwr.annoyDiff,upr.ymax=upr.upr.annoyDiff,
           m.ymin=m.lwr.annoyDiff,m.ymax=m.upr.annoyDiff,
           geom.text.size,theme.size,geom.point.size,colorl=cols25(),
           xlim.low=0,xlim.upp=100,ylim.low=-80,ylim.upp=70,
           ylabel="Difference between verbal and \n numeric annoyance scales at 65 dB(A)",
           xlabel=paste("Arithemic mean between methods at 65 dB(A)"))
ggsave("./outputs/BAPlot_65dB.pdf",
       plot = g.BA.65dB, width = 1800, height = 1000, units = "px",scale = 2)

#70 dB and 60 dB

g.BA.OtherdB<-baplotOpts(data = data.annoy.BA %>% ungroup %>% 
                                 filter(SPL!="65dB") %>%
                                 group_by(NoiseType,SPL,ANC) %>%
                                 arrange(NoiseType,SPL,ANC,by_group=T),
           X = annoyMean, Y = annoyDiff, color = NoiseType,
           fg.XY = as.formula(~SPL+NoiseType+ANC), np = seq(from=1 , to=8*40 , by=40),
           #hline for mean diff, upper LoA, lower LoA
           hl.mean=m.annoyDiff, hl.upper=upr.annoyDiff, hl.lower=lwr.annoyDiff,
           #lower/upper 95% limits of lwr/upr LoA & mean
           lwr.ymin=lwr.lwr.annoyDiff,lwr.ymax=lwr.upr.annoyDiff,
           upr.ymin=upr.lwr.annoyDiff,upr.ymax=upr.upr.annoyDiff,
           m.ymin=m.lwr.annoyDiff,m.ymax=m.upr.annoyDiff,
           geom.text.size,theme.size,geom.point.size,colorl=cols25(),
           xlim.low=0,xlim.upp=100,ylim.low=-70,ylim.upp=70,
           ylabel="Difference between verbal and \n numeric annoyance scales at 60 & 70 dB(A)",
           xlabel=paste("Arithemic mean between methods at 60 & 70 dB(A)"))
ggsave("./outputs/BAPlot_OtherdB.pdf",
       plot = g.BA.OtherdB, width = 1800, height = 700, units = "px",scale = 2)

```

### Summary stats

```{r}

dataRel.summary <- data.subj.rel %>%
        dplyr::select(!c("ID","desc","annoycat","ISOEV","ISOPL")) %>%
        #change order of factor
        dplyr::mutate(Masker=factor(Masker,levels = c("None","Bird","Water"))) %>%
        #filter(NoiseType=="Aircraft" & SPL=="65dB") %>%
        group_by(NoiseType,Masker,SPL,ANC) %>%
        dplyr::summarize(across(everything(), list(mean = mean, sd = sd)))

dataRel.summary.tbl <- dataRel.summary %>%
        mutate(across(2:21,round,2))%>%
        kableExtra::kbl(booktabs = T, linesep = "",
                        #row.names = NULL,
                        #format = "latex",
                        format = "html",
                        #format = "rst",
                        label = "qnDataSummary",
                        caption = "Summary of questionnaire scores on perceived
                        annoyance (PAY), perceived affective quality (PAQ), and
                        perceived loudness (PLN)") %>%
        #kable_styling(latex_table_env = "tabularx") %>%
        kable_paper(full_width = T) %>%
        collapse_rows(columns = 1:3, valign = "top") %>%
        add_header_above(c(" " = 4, "PAY" = 2, 
                           "PAQ" = 16, "PLN" = 2), bold = T) #%>%
        #save_kable(paste0(getwd(),"/qnDataSummary.tex"))
dataRel.summary.tbl
```

### ART Anova Annoyance

```{r}

shapiro.test(x = data.subj.rel$annoyscale)

#Aligned Rank Transformed ANOVA
m.art.annoyscale = ARTool::art(annoyscale ~ NoiseType * Masker * ANC + (1|ID), 
                               data=data.subj.rel) 
# linear mixed model syntax; see lme4::lmer
art.anova.annoyance<-anova(m.art.annoyscale)

#ART Effects sizes using Cohen's d
#https://cran.r-project.org/web/packages/ARTool/vignettes/art-effect-size.html#cohens-d
m.linear.annoyscale <- lm(annoyscale ~ NoiseType * Masker * ANC, 
                          data=data.subj.rel)
#PC with ANC conditions
ANC.contrasts.annoyscale <- summary(art.con(m.art.annoyscale, "ANC",
                                            adjust = "bonferroni"))
ANC.contrasts.annoyscale$d = ANC.contrasts.annoyscale$estimate / 
        car::sigmaHat(m.linear.annoyscale)
ANC.contrasts.annoyscale
#PC with Maskers
Masker.contrasts.annoyscale <- summary(art.con(m.art.annoyscale,
                                               "Masker",adjust = "bonferroni"))
Masker.contrasts.annoyscale$d <- Masker.contrasts.annoyscale$estimate / 
        car::sigmaHat(m.linear.annoyscale)
Masker.contrasts.annoyscale
#PC with NoiseType
NoiseType.contrasts.annoyscale <- summary(art.con(m.art.annoyscale, "NoiseType",
                                                  adjust = "bonferroni"))
NoiseType.contrasts.annoyscale$d <- NoiseType.contrasts.annoyscale$estimate / car::sigmaHat(m.linear.annoyscale)
NoiseType.contrasts.annoyscale
#PC with Masker and ANC
MaskANC.contrasts.annoyscale <- summary(art.con(m.art.annoyscale, "Masker:ANC",
                                                adjust = "bonferroni"))
MaskANC.contrasts.annoyscale$d <- NoiseType.contrasts.annoyscale$estimate / car::sigmaHat(m.linear.annoyscale)
MaskANC.contrasts.annoyscale

#Statistical test table for sentiment analysis
annoy.art.anova.stat<- as.data.frame(art.anova.annoyance) %>% 
        mutate(Test="3W-ART ANOVA", d="") %>%
        dplyr::select(!c("F","Df","Df.res")) %>%
        `rownames<-`(NULL) %>%
        `colnames<-`(c("Term","p-value","Test","d")) %>%
        relocate("Test",.after = "Term") %>%
        mutate(`p-value`=round(`p-value`,4))

annoy.stat.tbl <- rbind(annoy.art.anova.stat[1,], #noise type
                        as.data.frame(NoiseType.contrasts.annoyscale) %>% 
                                mutate(Test="ART Contrast") %>%
                               dplyr::select(!c("estimate","SE","df",
                                                "t.ratio")) %>%
                                `colnames<-`(c("Term","p-value","d","Test")) %>%
                                relocate("Test",.after = "Term") %>%
                                mutate(across(c("p-value","d"),round,4)),
                        annoy.art.anova.stat[2,], #masker
                        as.data.frame(Masker.contrasts.annoyscale) %>% 
                                mutate(Test="ART Contrast") %>%
                               dplyr::select(!c("estimate","SE","df",
                                                "t.ratio")) %>%
                                `colnames<-`(c("Term","p-value","d","Test")) %>%
                                relocate("Test",.after = "Term") %>%
                                mutate(across(c("p-value","d"),round,4)),
                        annoy.art.anova.stat[3,],
                        as.data.frame(ANC.contrasts.annoyscale) %>% 
                                mutate(Test="ART Contrast") %>%
                               dplyr::select(!c("estimate","SE","df",
                                                "t.ratio")) %>%
                                `colnames<-`(c("Term","p-value","d","Test")) %>%
                                relocate("Test",.after = "Term") %>%
                                mutate(across(c("p-value","d"),round,4)),
                        annoy.art.anova.stat[4:6,],
                        as.data.frame(MaskANC.contrasts.annoyscale) %>% 
                                mutate(Test="ART Contrast") %>%
                               dplyr::select(!c("estimate","SE","df",
                                                "t.ratio")) %>%
                                `colnames<-`(c("Term","p-value","d","Test")) %>%
                                relocate("Test",.after = "Term") %>%
                                mutate(across(c("p-value","d"),round,4)),
                        annoy.art.anova.stat[7,]) %>%
        `rownames<-`(NULL) %>%
        kableExtra::kbl(booktabs = T, linesep = "",
                        #row.names = NULL,
                        #format = "latex",
                        format = "html",
                        label = "annoyARTstats",
                        caption = "Summary of ART ANOVA and relevant post-hoc 
                        contrast tests for annoyance analysis") %>%
        #kable_styling(latex_table_env = "tabularx") %>%
        kable_paper(full_width = T) %>%
        #collapse_rows(columns = 1:2, valign = "top") %>%
        footnote(general = "*:p<0.05, **:p<0.01, ***:p<0.001, ****:p<0.0001") #%>%
        #save_kable(paste0(getwd(),"/annoyARTstats.tex"))
annoy.stat.tbl              

```