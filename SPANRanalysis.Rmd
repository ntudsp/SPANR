---
title: "Replication code for: Anti-noise window: subjective perception of active noise reduction and effect of informational masking"
output: github_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(dataverse)
library(raster)
library(lubridate)
library(rjson)
library(plyr)
library(dplyr)
library(tidyr)
library(ggplot2)
library(RColorBrewer)
library(stringr)
library(ggrepel)
library(scales)
library(reshape2)
library(psych)
library(psychTools)
library(RTHORR)
library(lsr)
library(readxl)
#library(kable)
library(kableExtra)
library(seewave)
library(gridExtra)

source("spanrFunc.R")
```

## Data loading

Load research data from data repository

```{r dataload}
#Set dataverse server
Sys.setenv("DATAVERSE_SERVER" = "https://researchdata.ntu.edu.sg")

#Retrieve research data from dataverse dataset
dv.dataset = "10.21979/N9/SEGEFM" #dataset linked to this paper
#define a list of data frame names and associated dataset file names
data.names <- data.frame(
        df.name=c(
                "data.subj","data.demo","data.spla","data.splc",
                "data.ffta","data.fftc","data.sv"),
        filename=c("SPANR_subj_clean.tab","SPANR_demo_clean.tab",
                   "SPANR_SPLdBA_clean.tab","SPANR_SPLdBC_clean.tab",
                   "SPANR_FFTdBA_clean.tab","SPANR_FFTdBC_clean.tab",
                   "SPANR_sv_clean.tab"))

# Empty list to store the data frames
data.l <- list()

for (name in data.names$df.name) {
        #get dataset from dataverse
        df<-get_dataframe_by_name(filename = data.names[data.names$df.name==name,
                                            "filename"],
                      dataset = dv.dataset, orginal = TRUE,
                      .f = function(x) read.table(x, header = TRUE, 
                                                  sep = "\t", fill = TRUE))
        
        #assign the data frame to pre-defined name
        assign(name, df)
        
        #add data frame to list
        data.l[[name]] <- df
}



```


## Data exploration and summary statistics

```{r explr, message=FALSE}

#no of participants
noPart<-44

#extract test tracks #1 and #26
part3<-data %>% 
        filter(NoiseType=="Traffic" & SPL=="60dB") %>%
        mutate(time=ifelse(row_number()<(noPart+1),1,2)) #create time column

#test-retest reliability between test tracks
testRT<-psych::testRetest(as.data.frame(part3),
                  select = c("annoyscale","loudness","pleasant","annoying",
                             "eventful","uneventful","vibrant","chaotic",
                             "monotonous","calm"))
#within person reliability
WPrelia<-testRT$scores$rqq 

#ID of unreliable
IDunRel<-data$ID[which(WPrelia<0.7)][]

#Remove data with poor reliability <0.7
dataRel <- data %>% filter(!ID %in% IDunRel)

#Update demographic
demoRel <- allDemo %>% filter(!ID %in% IDunRel) %>% filter(!ID==1)

```

## Circumplexity analysis

The circumplexity of the PAQ attributes are evaluated via the randomized test of hypothesized order relations (RTHOR) and sinusoidality.  The correspondence index (CI) indicates an 86% circumplexity fit (p<0.001).

```{r circum, message=FALSE}

#Check for circumplexity using RTHORR

#Pearson's correlation
cor.PAQ <- cor(dataRel %>% dplyr::select(eventful:chaotic),method = "pearson")

#RTHOR
randmf_output <- RTHORR::randmf_from_df(
  df_list = list(cor.PAQ,cor.PAQ),
  ord = "circular8")
paste0("Circumplexity fit: ",round(randmf_output$RTHOR$CI[1]*100,2),"%")

#PCA
pca.PAQ<-principal(dataRel %>% dplyr::select(eventful:chaotic), nfactors = 2,rotate = "none")

pca.PAQ$loadings

#Inequality check
##Adjacent v 1 hop
c(cor.PAQ[1,2],cor.PAQ[2,3],cor.PAQ[3,4],cor.PAQ[4,5],
  cor.PAQ[5,6],  cor.PAQ[6,7],cor.PAQ[7,8])>c(cor.PAQ[1,3])

c(cor.PAQ[1,2],cor.PAQ[2,3],cor.PAQ[3,4],cor.PAQ[4,5],
  cor.PAQ[5,6],  cor.PAQ[6,7],cor.PAQ[7,8])>c(cor.PAQ[2,4])

c(cor.PAQ[1,2],cor.PAQ[2,3],cor.PAQ[3,4],cor.PAQ[4,5],
  cor.PAQ[5,6],  cor.PAQ[6,7],cor.PAQ[7,8])>c(cor.PAQ[3,5])

c(cor.PAQ[1,2],cor.PAQ[2,3],cor.PAQ[3,4],cor.PAQ[4,5],
  cor.PAQ[5,6],  cor.PAQ[6,7],cor.PAQ[7,8])>c(cor.PAQ[4,6])

c(cor.PAQ[1,2],cor.PAQ[2,3],cor.PAQ[3,4],cor.PAQ[4,5],
  cor.PAQ[5,6],  cor.PAQ[6,7],cor.PAQ[7,8])>c(cor.PAQ[5,7])

c(cor.PAQ[1,2],cor.PAQ[2,3],cor.PAQ[3,4],cor.PAQ[4,5],
  cor.PAQ[5,6],  cor.PAQ[6,7],cor.PAQ[7,8])>c(cor.PAQ[6,8])

##1hop vs 2hop
c(cor.PAQ[1,3],cor.PAQ[2,4],cor.PAQ[3,5],cor.PAQ[4,6],
  cor.PAQ[5,7],  cor.PAQ[6,8])>c(cor.PAQ[1,4])

c(cor.PAQ[1,3],cor.PAQ[2,4],cor.PAQ[3,5],cor.PAQ[4,6],
  cor.PAQ[5,7],  cor.PAQ[6,8])>c(cor.PAQ[2,5])

c(cor.PAQ[1,3],cor.PAQ[2,4],cor.PAQ[3,5],cor.PAQ[4,6],
  cor.PAQ[5,7],  cor.PAQ[6,8])>c(cor.PAQ[3,6])

c(cor.PAQ[1,3],cor.PAQ[2,4],cor.PAQ[3,5],cor.PAQ[4,6],
  cor.PAQ[5,7],  cor.PAQ[6,8])>c(cor.PAQ[4,7])

c(cor.PAQ[1,3],cor.PAQ[2,4],cor.PAQ[3,5],cor.PAQ[4,6],
  cor.PAQ[5,7],  cor.PAQ[6,8])>c(cor.PAQ[5,8])

##2hop vs 3hop
c(cor.PAQ[1,4],cor.PAQ[2,5],cor.PAQ[3,6],cor.PAQ[4,7],
  cor.PAQ[5,8])>c(cor.PAQ[1,5])

c(cor.PAQ[1,4],cor.PAQ[2,5],cor.PAQ[3,6],cor.PAQ[4,7],
  cor.PAQ[5,8])>c(cor.PAQ[2,6])

c(cor.PAQ[1,4],cor.PAQ[2,5],cor.PAQ[3,6],cor.PAQ[4,7],
  cor.PAQ[5,8])>c(cor.PAQ[3,7])

c(cor.PAQ[1,4],cor.PAQ[2,5],cor.PAQ[3,6],cor.PAQ[4,7],
  cor.PAQ[5,8])>c(cor.PAQ[4,8])

```



## Three way anova analysis


### Loudness

```{r anova, echo=FALSE}
##65 dB: Effect of masker, noise type, anc
#three-way anova
loudness65dBModel <- aov(loudness ~ NoiseType * Masker * ANC, data=dataRel %>% filter(SPL=="65dB"))
summary(loudnessModel)
#remove 3 way interaction
loudness65dBModel1 <- update(loudnessModel, . ~ . -NoiseType:Masker:ANC)
summary(loudnessModel1)
#remove 2 way interaction
loudness65dBModel2 <- update(loudnessModel1,  .~NoiseType+Masker+ANC)
summary(loudnessModel2)

#paired comparisons
pcLoudness65dB<-TukeyHSD(loudnessModel2)

#mean scores
meanLoudness65dB <- dataRel %>%
        filter(SPL=="65dB") %>%
        group_by(NoiseType, Masker, ANC) %>%
        summarize(mean_loud=mean(loudness),sd_loud=sd(loudness))


##Effect of ANC both 65 dBA and 70 dBA
loudnessANCModel <- aov(loudness~NoiseType*SPL*ANC,data = dataRel %>% filter(Masker=="None"))
summary(loudnessANCModel)
loudnessANCModel1<-update(loudnessANCModel, . ~ . -NoiseType:SPL:ANC)
summary(loudnessANCModel1)

pcLoudnessANC<-TukeyHSD(loudnessANCModel1)

#mean scores for ANC
meanLoudnessANC <- dataRel %>%
        filter(Masker=="None") %>%
        group_by(NoiseType, SPL, ANC) %>%
        summarize(mean_loud=mean(loudness))




```

### PAQ

```{r PAQ,message=FALSE}

#ISO pleasant, ISO eventful

dataRel <- dataRel %>%
        #ISO 12913-3 normalise by (100+sqrt(20000))
        mutate(ISOPL=((pleasant-annoying)+cospi(0.25)*(calm-chaotic)+cospi(0.25)*(vibrant-monotonous))/(100+sqrt(20000))) %>%
        mutate(ISOEV=((eventful-uneventful)+cospi(0.25)*(chaotic-calm)+cospi(0.25)*(vibrant-monotonous))/(100+sqrt(20000)))

##three-way anova

ISOPLModel <- aov(ISOPL ~ NoiseType * Masker * ANC, data=dataRel %>% filter(SPL=="65dB"))
summary(ISOPLModel)

ISOPLModel1<-update(ISOPLModel, . ~ . -NoiseType:Masker:ANC)
summary(ISOPLModel1)

etaSquared(ISOPLModel1)

pcISOPL<-TukeyHSD(ISOPLModel1)

#check for and remove non-complete cases
dataRelComp <- dataRel %>% filter(complete.cases(.))

annoycatModel <- aov(annoycat ~ NoiseType * Masker * ANC, data=dataRelComp %>% filter(SPL=="65dB"))
summary(annoycatModel)




#mean scores
mean65dB <- dataRel %>%
        filter(SPL=="65dB") %>%
        group_by(NoiseType, Masker, ANC) %>%
        summarize(mu.ISOPL=mean(ISOPL),
                  mu.ISOEV=mean(ISOEV))

```
### dBA

```{r obj.dBA, message=FALSE}

#scatter plots of SPL

#summarise data for dBA plot
summary.SPL.df <- SPL.dBA.df %>%
        group_by(stimuliID,run) %>%
        summarise(across(-c(time),meandB)) %>% #compute Leq 30s
        #mutate() %>% #loudest ear
        rowwise() %>%
        mutate(#maxHATS=pmax(HATS.L,HATS.R),
               avgHATS=meandB(HATS.L,HATS.R), #energy ave HATS
               EA=meandB(c(mic5,mic13,mic14,
                           mic15,mic17,mic18))) %>% #energy ave mic 
        dplyr::select(!c(mic18:mic15)) %>%
        pivot_longer(cols=c("avgHATS","EA"),names_to = "Measurement",values_to = "dBA") %>%
        group_by(stimuliID,Measurement) %>%
        mutate(sd=sd(dBA)) %>%
        group_by(stimuliID,Measurement) %>%
        summarise(across(-c(run),meandB))

#noise floor
print(paste("Noise Floor:",round(summary.SPL.df[2,"dBA"],2),"Â±",
            round(summary.SPL.df[2,"sd"],2)))

summary.SPL.df <- summary.SPL.df %>% filter(!stimuliID==0)

stimuli.trackInfo <- trackInfo[2:nrow(trackInfo),]

#plot SPL dBA as a function of stimuli
ggplot(summary.SPL.df, aes(x = stimuliID, y = dBA, group=stimuliID, color=Measurement)) +
        geom_point() +
        geom_errorbar(aes(ymin=dBA-sd, ymax=dBA+sd), width=.2,
                 position=position_dodge(0.05))


```
### Single value objective indicators

```{r}

#stimuli names for plotting
stimuli.trackInfo.names <- trackInfo[2:nrow(trackInfo),] %>%
        mutate(NoiseType=ifelse(NoiseType=="Train","MRT",
                                ifelse(NoiseType=="Aircraft","AIR",
                                       ifelse(NoiseType=="Traffic","TRA",NoiseType))),
               Masker=ifelse(Masker=="Bird","B",
                             ifelse(Masker=="Water","W",Masker))) %>%
        mutate(stimuliID=row_number()) %>%
        mutate(stimuli.name=case_when(Masker=="None" & ANC == "No" ~ 
                                              paste0(NoiseType,"@",SPL),
                                      Masker=="None" & ANC == "Yes" ~ 
                                              paste0(NoiseType,"*","@",SPL),
                                      Masker!="None" & ANC == "No" ~ 
                                              paste0(NoiseType,"@",SPL,"+",Masker),
                                      Masker!="None" & ANC == "Yes" ~ 
                                              paste0(NoiseType,"*","@",SPL,"+",Masker)))

mean.SV <- data.sv %>%
        dplyr::select(!Channel) %>%
        dplyr::filter(!stimuliID==0) %>% #remove noise floor
        group_by(stimuliID,measurement) %>%
        dplyr::summarise(across(everything(),list(mean))) %>%
        ungroup %>%
        `colnames<-`(gsub("_1","",colnames(.))) %>%
        pivot_longer(cols = !c("stimuliID","measurement"), 
                     names_to = "Indicator",values_to = "Value") %>%
        pivot_wider(names_from = stimuliID,values_from = Value) %>%
        `colnames<-`(cbind(c("measurement","indicator",stimuli.trackInfo.names$stimuli.name)))

```
### SV Attenuation

```{r}

mean.SV.att <- mean.SV %>%
        filter(grepl("(C)|(A)", indicator)) %>%
        #compute attenuation
        mutate(`AIR@65dB`=`AIR@65dB`-`AIR*@65dB`,`MRT@65dB`=`MRT@65dB`-`MRT*@65dB`,
               `TRA@65dB`=`TRA@65dB`-`TRA*@65dB`,`AIR@70dB`=`AIR@70dB`-`AIR*@70dB`,
               `MRT@70dB`=`MRT@70dB`-`MRT*@70dB`,`TRA@70dB`=`TRA@70dB`-`TRA*@70dB`,
               `AIR@65dB+B`=`AIR@65dB+B`-`AIR*@65dB+B`,
               `MRT@65dB+B`=`MRT@65dB+B`-`MRT*@65dB+B`,
               `TRA@65dB+B`=`TRA@65dB+B`-`TRA*@65dB+B`,
               `AIR@65dB+W`=`AIR@65dB+W`-`AIR*@65dB+W`,
               `MRT@65dB+W`=`MRT@65dB+W`-`MRT*@65dB+W`,
               `TRA@65dB+W`=`TRA@65dB+W`-`TRA*@65dB+W`) %>%
        dplyr::select(!matches("\\*|60")) %>%
        mutate(weight=ifelse(grepl("(C)",indicator),"C","A")) %>%
        group_by(measurement,weight) %>%
        dplyr::summarise_all(list(mean=mean,sd=sd))
        
        

```


### FFT (dBA)

```{r FFTdBA, message=FALSE}

#color
set1clr<-brewer.pal(n = 9,"Set1")

#mean across runs and EA/HATS channels
summary.FFT.dBA.df <- FFT.dBA.df %>%
        #mean across runs
        group_by(freq,stimuliID) %>%
        dplyr::summarise(across(-c(run),list(meandB))) %>%
        ungroup() %>%
        `colnames<-`(gsub("_1","",colnames(.))) %>% #remove "_1"
        rowwise() %>% #mean across EA/HATS mics
        mutate(EA=meandB(c(mic5,mic13,mic14,mic15,mic17,mic18)),
               HATS=meandB(c(HATS.L,HATS.R))) %>%
        dplyr::select(!c(mic5,mic13,mic14,mic15,mic17,mic18,HATS.L,HATS.R)) %>%
        filter(!stimuliID==0) %>%
        ungroup() %>%
        left_join(.,stimuli.trackInfo.names,by="stimuliID") %>%
        pivot_longer(cols = c(EA,HATS),names_to = "measurement",values_to = "dBA")
        
g.65dB<-ggplot(data = summary.FFT.df %>% 
               mutate(stimuliID=as.factor(stimuliID)) %>%
               filter(SPL=="65dB"), 
       aes(x = freq,y = dBA,color=Masker)) +
        facet_grid(NoiseType~measurement) +
        geom_line(aes(linetype=ANC))+
        scale_x_log10(limits=c(100,10000)) +
        annotation_logticks(sides="b") + 
        scale_color_manual(values = set1clr) +
        ylim(20,50) + xlab("Frequency, Hz") + 
        scale_color_manual(values = set1clr) +
        ylab ("Sound Pressure Level, dB(A)") + theme(legend.position="bottom")
g.65dB

ggsave("65dBA_HATS.pdf",plot = g.65dB, width = 1800, height = 1500, units = "px",scale = 1)

#70 dBA only HATS
g.70dBA<-ggplot(data = summary.FFT.dBA.df %>% 
               mutate(stimuliID=as.factor(stimuliID)) %>%
               filter(SPL=="70dB" & measurement=="HATS"), 
       aes(x = freq,y = dBA,color=NoiseType)) +
        facet_wrap(~NoiseType,nrow = 3) +
        geom_line(aes(linetype=ANC))+
        ylim(24,55) + xlab("Frequency, Hz") + 
        scale_color_manual(values = set1clr) +
        ylab ("Sound Pressure Level, dB(A)") +
        scale_x_log10(limits=c(100,10000)) +
        annotation_logticks(sides="b") +
        theme(legend.position="none",panel.grid.minor = element_blank())
g.70dBA
ggsave("70dBA_HATS.pdf",plot = g.70dBA, width = 900, height = 1500, units = "px",scale = 1)
```

### FFT (dBC)

```{r FFT, message=FALSE}

#color
set1clr<-brewer.pal(n = 9,"Set1")

#mean across runs and EA/HATS channels
summary.FFT.dBC.df <- FFT.dBC.df %>%
        #mean across runs
        group_by(freq,stimuliID) %>%
        dplyr::summarise(across(-c(run),list(meandB))) %>%
        ungroup() %>%
        `colnames<-`(gsub("_1","",colnames(.))) %>% #remove "_1"
        rowwise() %>% #mean across EA/HATS mics
        mutate(EA=meandB(c(mic5,mic13,mic14,mic15,mic17,mic18)),
               HATS=meandB(c(HATS.L,HATS.R))) %>%
        dplyr::select(!c(mic5,mic13,mic14,mic15,mic17,mic18,HATS.L,HATS.R)) %>%
        filter(!stimuliID==0) %>%
        ungroup() %>%
        left_join(.,stimuli.trackInfo.names,by="stimuliID") %>%
        pivot_longer(cols = c(EA,HATS),names_to = "measurement",values_to = "dBC")
        
g.65dBC<-ggplot(data = summary.FFT.dBC.df %>% 
               mutate(stimuliID=as.factor(stimuliID)) %>%
               filter(SPL=="65dB"), 
       aes(x = freq,y = dBC,color=Masker)) +
        facet_grid(NoiseType~measurement) +
        geom_line(aes(linetype=ANC))+
        scale_x_log10(limits=c(100,10000)) +
        annotation_logticks(sides="b") + 
        scale_color_manual(values = set1clr) +
        ylim(20,50) + xlab("Frequency, Hz") + 
        scale_color_manual(values = set1clr) +
        ylab ("Sound Pressure Level, dB(C)") + theme(legend.position="bottom")
g.65dBC

ggsave("65dBC_HATS.pdf",plot = g.65dBC, width = 1800, height = 1500, units = "px",scale = 1)

#70 dBA only HATS
g.70dBC<-ggplot(data = summary.FFT.dBC.df %>% 
               mutate(stimuliID=as.factor(stimuliID)) %>%
               filter(SPL=="70dB" & measurement=="HATS"), 
       aes(x = freq,y = dBC,color=NoiseType)) +
        facet_wrap(~NoiseType,nrow = 3) +
        geom_line(aes(linetype=ANC))+
        ylim(24,55) + xlab("Frequency, Hz") + 
        scale_color_manual(values = set1clr) +
        ylab ("Sound Pressure Level, dB(C)") +
        scale_x_log10(limits=c(100,10000)) +
        annotation_logticks(sides="b") +
        theme(legend.position="none",panel.grid.minor = element_blank())
g.70dBC
ggsave("70dBC_HATS.pdf",plot = g.70dBC, width = 900, height = 1500, units = "px",scale = 1)

#create combined plot of 70dBA and 70dBC

#70 dBA only HATS
g.70dBC_legend<-ggplot(data = summary.FFT.dBC.df %>% 
               mutate(stimuliID=as.factor(stimuliID)) %>%
               filter(SPL=="70dB" & measurement=="HATS"), 
       aes(x = freq,y = dBC,color=NoiseType)) +
        facet_wrap(~NoiseType,nrow = 3) +
        geom_line(aes(linetype=ANC))+
        ylim(24,55) + xlab("Frequency, Hz") + 
        scale_color_manual(values = set1clr) +
        ylab ("Sound Pressure Level, dB(C)") +
        scale_x_log10(limits=c(100,10000)) +
        annotation_logticks(sides="b") +
        theme(legend.position="bottom",panel.grid.minor = element_blank())

# Create user-defined function, which extracts legends from ggplots
extract_legend <- function(my_ggp) {
  step1 <- ggplot_gtable(ggplot_build(my_ggp))
  step2 <- which(sapply(step1$grobs, function(x) x$name) == "guide-box")
  step3 <- step1$grobs[[step2]]
  return(step3)
}

# Apply user-defined function to extract legend
shared_legend <- extract_legend(g.70dBC_legend)

# combine plots with shared legend
g.comb.70dB<-grid.arrange(arrangeGrob(g.70dBA, g.70dBC, ncol = 2),
             shared_legend, nrow = 2, heights = c(20, 1))

ggsave("70dB_HATS_comb.pdf",plot = g.comb.70dB, width = 1800, height = 1500, units = "px",scale = 1)

```

